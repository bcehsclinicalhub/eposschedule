<script>
  const today = new Date();
  const tomorrow = new Date();
  tomorrow.setDate(today.getDate() + 1);

  // Format: YYYY-MM-DD for easy string comparison
  const todayStr = today.toISOString().split('T')[0];
  const tomorrowStr = tomorrow.toISOString().split('T')[0];

  const dateLabel = (dateStr) => {
    const d = new Date(dateStr);
    const options = { weekday: 'short', month: 'short', day: 'numeric' };
    return d.toLocaleDateString(undefined, options);
  };

  const apiBase = 'https://ca.bytebloc.com/sk/Svc/getMasterSchedule/V5/BCEHS/BCEHS/d31648c6853e464aa71c9ff0be062f2a/';
  const apiDate = todayStr.split('-').reverse().join('-'); // convert YYYY-MM-DD to DD-MM-YYYY
  const apiUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(`${apiBase}${apiDate}?format=XML`);

  fetch(apiUrl)
    .then(response => response.text())
    .then(xmlText => {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

      const providerMap = new Map();
      const shiftMap = new Map();

      // Build Provider Map
      const providers = xmlDoc.getElementsByTagName('Provider');
      for (let p of providers) {
        const id = p.getElementsByTagName('ProviderId')[0]?.textContent;
        const name = `${p.getElementsByTagName('FirstName')[0]?.textContent || ''} ${p.getElementsByTagName('LastName')[0]?.textContent || ''}`.trim();
        if (id) providerMap.set(id, name);
      }

      // Build Shift Map
      const shifts = xmlDoc.getElementsByTagName('Shift');
      for (let s of shifts) {
        const id = s.getElementsByTagName('ShiftId')[0]?.textContent;
        const name = s.getElementsByTagName('ShiftName')[0]?.textContent || '';
        const start = s.getElementsByTagName('ShiftStartTime')[0]?.textContent || '';
        const end = s.getElementsByTagName('ShiftEndTime')[0]?.textContent || '';
        if (id) shiftMap.set(id, { name, start, end });
      }

      // Filter and display Assignments for today or tomorrow
      const assignments = xmlDoc.getElementsByTagName('Assignment');
      let relevantAssignments = [];

      for (let a of assignments) {
        const provId = a.getElementsByTagName('ProviderId')[0]?.textContent;
        const shiftId = a.getElementsByTagName('ShiftId')[0]?.textContent;
        const dateStr = a.getElementsByTagName('StartDate')[0]?.textContent || '';

        if (!provId || !shiftId || !dateStr) continue;

        if (![todayStr, tomorrowStr].includes(dateStr)) continue;

        const provName = providerMap.get(provId) || 'Unknown';
        const shift = shiftMap.get(shiftId) || { name: 'Unknown', start: '', end: '' };

        relevantAssignments.push({
          date: dateStr,
          name: provName,
          shiftName: shift.name,
          time: `${shift.start}â€“${shift.end}`
        });
      }

      if (relevantAssignments.length === 0) {
        document.getElementById('scheduleContainer').textContent = 'No assignments for today or tomorrow.';
        return;
      }

      // Sort and display
      relevantAssignments.sort((a, b) => {
        if (a.date === b.date) return a.name.localeCompare(b.name);
        return new Date(a.date) - new Date(b.date);
      });

      let html = '<table><thead><tr><th>Date</th><th>Provider</th><th>Shift</th><th>Time</th></tr></thead><tbody>';
      for (let a of relevantAssignments) {
        html += `<tr>
          <td>${dateLabel(a.date)}</td>
          <td>${a.name}</td>
          <td>${a.shiftName}</td>
          <td>${a.time}</td>
        </tr>`;
      }
      html += '</tbody></table>';

      document.getElementById('scheduleContainer').innerHTML = html;
    })
    .catch(err => {
      console.error('Error:', err);
      document.getElementById('scheduleContainer').textContent = 'Error loading schedule.';
    });
</script>
